<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task+ ‚Äî Gerenciador & Desempenho</title>
  <style>
    :root { --bg:#f6f6f6; --card:#fff; --text:#111; --muted:#6b7280; --border:#e5e7eb; --radius:16px; --ring:#2563eb; }
    *{ box-sizing: border-box; } body{ margin:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .container{ max-width: 1100px; margin: 0 auto; padding: 24px;}
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 1px 2px rgba(0,0,0,.04); padding:16px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn{ background:#fff; border:1px solid var(--border); border-radius:999px; padding:8px 12px; cursor:pointer; display:inline-flex; gap:8px; align-items:center; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn:hover{ box-shadow:0 2px 6px rgba(0,0,0,.06); }
    .input,.select{ border:1px solid var(--border); border-radius:12px; padding:8px 10px; }
    .title{ font-weight:800; font-size:24px; } .muted{ color:var(--muted); font-size:12px; }
    .list{ display:grid; gap:8px; } .item{ border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:space-between; transition: box-shadow .2s, outline .2s; }
    .strike{ text-decoration:line-through; color:#9ca3af; }
    .kpis{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }
    .fields{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
    .chart{ height:280px; }
    .ring { outline: 3px solid var(--ring); }
  </style>
</head>
<body>
  <div class="container">
    <header class="row" style="justify-content:space-between;">
      <div class="title">Task+ ‚Äî Gerenciador & Desempenho</div>
      <div class="row">
        <button id="exportCsvBtn" class="btn">‚¨áÔ∏è Exportar CSV</button>
        <label class="btn">‚¨ÜÔ∏è Importar CSV <input id="importCsvInput" type="file" accept=".csv" style="display:none"></label>
      </div>
    </header>

    <!-- Nova tarefa no topo -->
    <section class="card">
      <h2 style="margin:0 0 8px 0;font-size:18px;">‚ûï Nova tarefa</h2>
      <div class="fields">
        <input id="title" class="input" placeholder="T√≠tulo" />
        <input id="category" class="input" placeholder="Categoria" />
        <input id="due" class="input" type="date" />
        <select id="type" class="select">
          <option value="daily">Di√°ria</option><option value="single">Pontual</option>
          <option value="weekly">Semanal</option><option value="monthly">Mensal</option>
        </select>
        <input id="minutes" class="input" type="number" min="5" step="5" value="30" />
        <input id="remindAt" class="input" type="datetime-local" />
      </div>
      <div class="row" style="margin-top:8px;"><button id="addBtn" class="btn">üíæ Adicionar</button></div>
    </section>

    <section class="kpis">
      <div class="card">
        <div class="muted">Hoje</div>
        <div id="kpiToday" style="font-size:28px;font-weight:700">0%</div>
        <div class="muted"><span id="kpiTodayDone">0</span>/<span id="kpiTodayTotal">0</span> conclu√≠das</div>
      </div>
      <div class="card">
        <div class="muted">Per√≠odo</div>
        <div id="kpiPeriod" style="font-size:28px;font-weight:700">0%</div>
        <div class="muted"><span id="kpiDays">0</span> dia(s) analisado(s)</div>
      </div>
      <div class="card">
        <div class="muted">Timer (25:00)</div>
        <div id="timerClock" style="font-size:28px;font-weight:700">25:00</div>
        <div class="row">
          <button id="timerStart" class="btn">‚è±Ô∏è Iniciar</button>
          <button id="timerPause" class="btn">‚è∏Ô∏è Pausar</button>
          <button id="timerReset" class="btn">üîÑ Reset</button>
        </div>
      </div>
    </section>

    <section class="card row" style="justify-content:space-between;align-items:flex-end;">
      <div class="row">
        <div><div class="muted">In√≠cio</div><input id="startDate" type="date" class="input" /></div>
        <div><div class="muted">Fim</div><input id="endDate" type="date" class="input" /></div>
        <div class="row"><button id="btnToday" class="btn">üìÖ Hoje</button><button id="btnWeek" class="btn">Semana</button><button id="btnMonth" class="btn">M√™s</button></div>
      </div>
      <label class="row"><input type="checkbox" id="showDone" checked><span>Mostrar conclu√≠das</span></label>
    </section>

    <section class="card">
      <div class="row" style="gap:8px;margin-bottom:8px;"><span>üìà</span><h2 style="margin:0;font-size:18px;">Desempenho</h2></div>
      <div id="chart" class="chart"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px 0;font-size:18px;">üîî Lembretes</h2>
      <div class="fields">
        <div><div class="muted">Manh√£</div><input id="remMorning" type="time" class="input"></div>
        <div><div class="muted">Meio-dia</div><input id="remMidday" type="time" class="input"></div>
        <div><div class="muted">Noite</div><input id="remNight" type="time" class="input"></div>
        <button id="enableNotif" class="btn">üîî Ativar notifica√ß√µes</button>
        <button id="exportIcs" class="btn">üîó Exportar .ics</button>
      </div>
      <label class="row" style="margin-top:8px;"><input type="checkbox" id="notifEnabled"><span>Notifica√ß√µes ativas</span></label>
      <div id="notifWarn" class="muted" style="margin-top:6px;display:none;color:#b91c1c;">Seu navegador n√£o suporta notifica√ß√µes.</div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px;">
        <h2 style="margin:0;font-size:18px;">Tarefas</h2><small class="muted"><span id="count">0</span> itens</small>
      </div>
      <div id="list" class="list"></div>
      <div id="empty" class="muted" style="text-align:center;padding:24px;display:none;">Sem tarefas no per√≠odo selecionado.</div>
      <div id="listEnd"></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px 0;">Opera√ß√µes do dia</h3>
      <div class="row"><button id="quickToday" class="btn">üìÖ Hoje</button><button id="clearToday" class="btn">üßπ Limpar tarefas de hoje</button></div>
    </section>
  </div>

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Recharts UMD -->
  <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
  <!-- Babel (para compilar JSX no navegador) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } = Recharts;
    const todayISO = () => new Date().toISOString().slice(0,10);
    const fmtDate = (d) => new Date(d).toLocaleDateString();
    const uid = () => Math.random().toString(36).slice(2,9);

    function toCSV(rows){
      const headers = ["id","title","category","due","minutes","type","done","remindAt","createdAt"];
      const lines = [headers.join(",")];
      rows.forEach(r=>{ lines.push(headers.map(h => (""+(r[h]??"")).replaceAll(",",";")).join(",")); });
      return lines.join("\n");
    }
    function fromCSV(text){
      const [header, ...rest] = text.trim().split(/\r?\n/);
      const keys = header.split(",");
      return rest.map(line => {
        const vals = line.split(",");
        const o = {}; keys.forEach((k,i)=>o[k]=vals[i]);
        o.minutes = Number(o.minutes||0); o.done = String(o.done).toLowerCase()==="true";
        if(o.createdAt) o.createdAt = Number(o.createdAt);
        return o;
      });
    }

    function canNotify(){ return "Notification" in window; }
    async function askPermission(){ if(!canNotify()) return "denied"; if(Notification.permission!=="granted"){ return await Notification.requestPermission(); } return "granted"; }
    function notify({title, body}){ if(canNotify() && Notification.permission==="granted"){ new Notification(title, { body }); } }

    function buildICS(times){
      const now = new Date(); const dtstamp = now.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
      const makeEvent = (label, hhmm)=>{ const [h,m] = hhmm.split(":"); const start = new Date(); start.setHours(+h,+m,0,0);
        const DTSTART = start.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
        return ["BEGIN:VEVENT","UID:"+ (crypto.randomUUID?.()||uid()) +"@taskplus","DTSTAMP:"+dtstamp,"DTSTART:"+DTSTART,"RRULE:FREQ=DAILY","SUMMARY:Task+ ‚Äî Lembrete: "+label,"END:VEVENT"].join("\n"); };
      const body = ["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Task+//PT-BR",""+makeEvent("Revisar prioridades", times.morning),""+makeEvent("Check-in", times.midday),""+makeEvent("Revis√£o do dia", times.night),"END:VCALENDAR"].join("\n");
      return new Blob([body], { type:"text/calendar;charset=utf-8" });
    }

    function addDaysISO(iso, n){ const d = new Date(iso); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
    function adjustRemindAtForDate(dueISO, remindAt){ if(!remindAt) return ""; const t = (remindAt.split('T')[1]||'').slice(0,5); if(!t) return ""; return `${dueISO}T${t}`; }
    function cloneDailyTasks(base, days=30){ const arr = []; for(let i=1;i<=days;i++){ const due = addDaysISO(base.due, i); arr.push({ ...base, id: uid(), due, remindAt: adjustRemindAtForDate(due, base.remindAt), createdAt: Date.now()+i }); } return arr; }

    function App(){
      const [tasks, setTasks] = React.useState([]);
      const [draft, setDraft] = React.useState({ id: uid(), title:"", category:"Geral", due: todayISO(), minutes:30, type:"daily", done:false, remindAt:"", createdAt: 0 });
      const [filter, setFilter] = React.useState({ start: todayISO(), end: todayISO() });
      const [showDone, setShowDone] = React.useState(true);
      const [timer, setTimer] = React.useState({ running:false, seconds:25*60 });
      const [reminders, setReminders] = React.useState({ enabled:false, times:{ morning:"08:00", midday:"13:00", night:"20:30" }, lastFired:{} });
      const [highlightId, setHighlightId] = React.useState(null);

      React.useEffect(()=>{ try{ setTasks(JSON.parse(localStorage.getItem("taskplus.tasks")||"[]")); }catch{} },[]);
      React.useEffect(()=> localStorage.setItem("taskplus.tasks", JSON.stringify(tasks)), [tasks]);
      React.useEffect(()=> localStorage.setItem("taskplus.reminders", JSON.stringify(reminders)), [reminders]);

      const filtered = React.useMemo(()=>{
        const s = filter.start ? new Date(filter.start) : null;
        const e = filter.end ? new Date(filter.end) : null; if(e) e.setHours(23,59,59,999);
        return tasks.filter(t=>{ const d=new Date(t.due); const okS=!s||d>=s; const okE=!e||d<=e; return okS&&okE&&(showDone||!t.done); })
                    .sort((a,b)=> (new Date(a.due)-new Date(b.due)) || ((a.createdAt||0)-(b.createdAt||0)));
      },[tasks,filter,showDone]);

      const byDate = React.useMemo(()=>{
        const m=new Map(); filtered.forEach(t=>{ const k=t.due; if(!m.has(k)) m.set(k,{date:k,total:0,done:0}); const r=m.get(k); r.total++; r.done+=t.done?1:0; });
        return [...m.values()].map(r=>({...r,pct:r.total?Math.round(100*r.done/r.total):0})).sort((a,b)=>a.date.localeCompare(b.date));
      },[filtered]);

      const todayStats = React.useMemo(()=> byDate.find(r=>r.date===todayISO()) || {total:0,done:0,pct:0}, [byDate]);

      React.useEffect(()=>{ if(!timer.running) return; const id=setInterval(()=>{ setTimer(t=> t.seconds>0?({...t,seconds:t.seconds-1}):({...t,running:false})); },1000); return ()=>clearInterval(id); },[timer.running]);
      const minutes = String(Math.floor(timer.seconds/60)).padStart(2,"0"); const seconds = String(timer.seconds%60).padStart(2,"0");

      function includeDate(d){
        if(!filter.start||!filter.end){ setFilter({start:d,end:d}); return; }
        const s=new Date(filter.start), e=new Date(filter.end); e.setHours(23,59,59,999); const nd=new Date(d);
        if(nd<s||nd>e){ setFilter({start:d,end:d}); }
      }

      function exportCSV(){ const blob = new Blob([toCSV(tasks)], { type:"text/csv;charset=utf-8;" }); const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`taskplus_${todayISO()}.csv`; a.click(); URL.revokeObjectURL(url); }
      function importCSV(file){ const reader = new FileReader(); reader.onload=()=>{ try{ setTasks(fromCSV(String(reader.result))); }catch{ alert("CSV inv√°lido"); } }; reader.readAsText(file); }

      function addTask(){
        const title = document.getElementById("title").value.trim();
        if(!title){ alert("Digite um t√≠tulo."); return; }
        const t = {
          id: uid(),
          title,
          category: document.getElementById("category").value || "Geral",
          due: document.getElementById("due").value || todayISO(),
          type: document.getElementById("type").value || "daily",
          minutes: Number(document.getElementById("minutes").value || 30),
          remindAt: document.getElementById("remindAt").value || "",
          done: false,
          createdAt: Date.now()
        };
        let toAdd=[t];
        if(t.type==="daily"){ toAdd=[t, ...cloneDailyTasks(t, 30)]; }
        setTasks(p=>[...p, ...toAdd]);
        includeDate(t.due);
        setHighlightId(t.id); setTimeout(()=> setHighlightId(null), 2000);
        document.getElementById("title").value=""; document.getElementById("remindAt").value="";
        setTimeout(()=> document.getElementById("listEnd").scrollIntoView({behavior:"smooth"}), 50);
      }

      function clearDay(date){ setTasks(p=>p.filter(t=>t.due!==date)); }

      React.useEffect(()=>{
        document.getElementById("startDate").value=filter.start; document.getElementById("endDate").value=filter.end;
        document.getElementById("startDate").onchange=e=>setFilter(f=>({...f,start:e.target.value}));
        document.getElementById("endDate").onchange=e=>setFilter(f=>({...f,end:e.target.value}));
        document.getElementById("showDone").onchange=e=>setShowDone(e.target.checked);
        document.getElementById("btnToday").onclick=()=>setFilter({start:todayISO(),end:todayISO()});
        document.getElementById("btnWeek").onclick=()=>{ const d=new Date(); const day=d.getDay(); const dif=(day+6)%7; const s=new Date(d); s.setDate(d.getDate()-dif); const e=new Date(s); e.setDate(s.getDate()+6); setFilter({start:s.toISOString().slice(0,10),end:e.toISOString().slice(0,10)}); };
        document.getElementById("btnMonth").onclick=()=>{ const d=new Date(); const s=new Date(d.getFullYear(),d.getMonth(),1); const e=new Date(d.getFullYear(),d.getMonth()+1,0); setFilter({start:s.toISOString().slice(0,10),end:e.toISOString().slice(0,10)}); };
        document.getElementById("exportCsvBtn").onclick=exportCSV;
        document.getElementById("importCsvInput").onchange=(e)=>{ const f=e.target.files?.[0]; if(f) importCSV(f); e.target.value=""; };
        document.getElementById("enableNotif").onclick=async()=>{ const perm=await askPermission(); if(perm!=="granted"){ alert("Ative as notifica√ß√µes do navegador."); return; } setReminders(r=>({...r,enabled:true})); notify({title:"Task+",body:"Notifica√ß√µes do Task+ ativadas."}); };
        document.getElementById("exportIcs").onclick=()=>{ const blob=buildICS(reminders.times); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="taskplus_lembretes.ics"; a.click(); URL.revokeObjectURL(url); };
        document.getElementById("notifWarn").style.display=("Notification" in window)?"none":"block";
        document.getElementById("due").value=todayISO();
        document.getElementById("addBtn").onclick=addTask;
        document.getElementById("quickToday").onclick=()=>setFilter({start:todayISO(),end:todayISO()});
        document.getElementById("clearToday").onclick=()=>clearDay(todayISO());
        document.getElementById("timerStart").onclick=()=>setTimer({running:true,seconds:25*60});
        document.getElementById("timerPause").onclick=()=>setTimer(t=>({...t,running:false}));
        document.getElementById("timerReset").onclick=()=>setTimer({running:false,seconds:25*60});
      },[filter,reminders]);

      React.useEffect(()=>{ document.getElementById("timerClock").textContent = minutes+":"+seconds; },[minutes,seconds]);

      React.useEffect(()=>{ 
        document.getElementById("kpiToday").textContent=(todayStats.pct||0)+"%";
        document.getElementById("kpiTodayDone").textContent=todayStats.done||0;
        document.getElementById("kpiTodayTotal").textContent=todayStats.total||0;
        document.getElementById("count").textContent=filtered.length;
        const days=byDate.length; const avg=Math.round((byDate.reduce((a,b)=>a+b.pct,0)/(days||1))); document.getElementById("kpiPeriod").textContent=(avg||0)+"%"; document.getElementById("kpiDays").textContent=days;
        const empty=document.getElementById("empty"); const list=document.getElementById("list"); list.innerHTML="";
        if(!filtered.length){ empty.style.display="block"; } else { empty.style.display="none";
          filtered.forEach(t=>{ const div=document.createElement("div"); div.className="item"+(t.id=== (highlightId||'__') ? " ring" : ""); // destaque 2s
            const left=document.createElement("div"); left.className="row";
            const toggle=document.createElement("button"); toggle.className="btn"; toggle.textContent=t.done?"‚úÖ":"‚≠ï"; toggle.onclick=()=>setTasks(p=>p.map(x=>x.id===t.id?{...x,done:!x.done}:x));
            const content=document.createElement("div"); const title=document.createElement("div"); title.textContent=t.title; if(t.done) title.className="strike";
            const meta=document.createElement("div"); meta.className="muted"; meta.innerHTML=[t.category,"‚Ä¢",fmtDate(t.due),"‚Ä¢",t.type,"‚Ä¢",(t.minutes||0)+" min",(t.remindAt?(" ‚Ä¢ üîî "+new Date(t.remindAt).toLocaleString()):"")].join(" ");
            content.appendChild(title); content.appendChild(meta); left.appendChild(toggle); left.appendChild(content);
            const right=document.createElement("div"); const del=document.createElement("button"); del.className="btn"; del.textContent="üóëÔ∏è Excluir"; del.onclick=()=>setTasks(p=>p.filter(x=>x.id!==t.id)); right.appendChild(del);
            div.appendChild(left); div.appendChild(right); list.appendChild(div); });
        }
      },[filtered,byDate,todayStats,highlightId]);

      return React.createElement('div', null);
    }

    const root = ReactDOM.createRoot(document.getElementById("chart"));
    root.render(React.createElement(App));
  </script>
</body>
</html>
