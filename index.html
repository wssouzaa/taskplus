<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task+ — Gerenciador & Desempenho</title>
  <style>
    :root { --bg:#f6f6f6; --card:#fff; --text:#111; --muted:#6b7280; --border:#e5e7eb; --radius:16px; }
    *{ box-sizing: border-box; } body{ margin:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .container{ max-width: 1100px; margin: 0 auto; padding: 24px;}
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 1px 2px rgba(0,0,0,.04); padding:16px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn{ background:#fff; border:1px solid var(--border); border-radius:999px; padding:8px 12px; cursor:pointer; display:inline-flex; gap:8px; align-items:center; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn:hover{ box-shadow:0 2px 6px rgba(0,0,0,.06); }
    .input,.select{ border:1px solid var(--border); border-radius:12px; padding:8px 10px; }
    .title{ font-weight:800; font-size:24px; } .muted{ color:var(--muted); font-size:12px; }
    .list{ display:grid; gap:8px; } .item{ border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:space-between; }
    .strike{ text-decoration:line-through; color:#9ca3af; } .kpis{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }
    .fields{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; } .chart{ height:280px; }
  </style>
</head>
<body>
  <div class="container">
    <header class="row" style="justify-content:space-between;">
      <div class="title">Task+ — Gerenciador & Desempenho</div>
      <div class="row">
        <button id="exportCsvBtn" class="btn">⬇️ Exportar CSV</button>
        <label class="btn">⬆️ Importar CSV <input id="importCsvInput" type="file" accept=".csv" style="display:none"></label>
      </div>
    </header>

    <section class="kpis">
      <div class="card">
        <div class="muted">Hoje</div>
        <div id="kpiToday" style="font-size:28px;font-weight:700">0%</div>
        <div class="muted"><span id="kpiTodayDone">0</span>/<span id="kpiTodayTotal">0</span> concluídas</div>
      </div>
      <div class="card">
        <div class="muted">Período</div>
        <div id="kpiPeriod" style="font-size:28px;font-weight:700">0%</div>
        <div class="muted"><span id="kpiDays">0</span> dia(s) analisado(s)</div>
      </div>
      <div class="card">
        <div class="muted">Timer (25:00)</div>
        <div id="timerClock" style="font-size:28px;font-weight:700">25:00</div>
        <div class="row">
          <button id="timerStart" class="btn">⏱️ Iniciar</button>
          <button id="timerPause" class="btn">⏸️ Pausar</button>
          <button id="timerReset" class="btn">🔄 Reset</button>
        </div>
      </div>
    </section>

    <section class="card row" style="justify-content:space-between;align-items:flex-end;">
      <div class="row">
        <div><div class="muted">Início</div><input id="startDate" type="date" class="input" /></div>
        <div><div class="muted">Fim</div><input id="endDate" type="date" class="input" /></div>
        <div class="row"><button id="btnToday" class="btn">📅 Hoje</button><button id="btnWeek" class="btn">Semana</button><button id="btnMonth" class="btn">Mês</button></div>
      </div>
      <label class="row"><input type="checkbox" id="showDone" checked><span>Mostrar concluídas</span></label>
    </section>

    <section class="card">
      <div class="row" style="gap:8px;margin-bottom:8px;"><span>📈</span><h2 style="margin:0;font-size:18px;">Desempenho</h2></div>
      <div id="chart" class="chart"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px 0;font-size:18px;">🔔 Lembretes</h2>
      <div class="fields">
        <div><div class="muted">Manhã</div><input id="remMorning" type="time" class="input"></div>
        <div><div class="muted">Meio-dia</div><input id="remMidday" type="time" class="input"></div>
        <div><div class="muted">Noite</div><input id="remNight" type="time" class="input"></div>
        <button id="enableNotif" class="btn">🔔 Ativar notificações</button>
        <button id="exportIcs" class="btn">🔗 Exportar .ics</button>
      </div>
      <label class="row" style="margin-top:8px;"><input type="checkbox" id="notifEnabled"><span>Notificações ativas</span></label>
      <div id="notifWarn" class="muted" style="margin-top:6px;display:none;color:#b91c1c;">Seu navegador não suporta notificações.</div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px 0;font-size:18px;">➕ Nova tarefa</h2>
      <div class="fields">
        <input id="title" class="input" placeholder="Título" />
        <input id="category" class="input" placeholder="Categoria" />
        <input id="due" class="input" type="date" />
        <select id="type" class="select">
          <option value="daily">Diária</option><option value="single">Pontual</option>
          <option value="weekly">Semanal</option><option value="monthly">Mensal</option>
        </select>
        <input id="minutes" class="input" type="number" min="5" step="5" value="30" />
        <input id="remindAt" class="input" type="datetime-local" />
      </div>
      <div class="row" style="margin-top:8px;"><button id="addBtn" class="btn">💾 Adicionar</button></div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px;">
        <h2 style="margin:0;font-size:18px;">Tarefas</h2><small class="muted"><span id="count">0</span> itens</small>
      </div>
      <div id="list" class="list"></div>
      <div id="empty" class="muted" style="text-align:center;padding:24px;display:none;">Sem tarefas no período selecionado.</div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px 0;">Operações do dia</h3>
      <div class="row"><button id="quickToday" class="btn">📅 Hoje</button><button id="clearToday" class="btn">🧹 Limpar tarefas de hoje</button></div>
    </section>
  </div>

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Recharts UMD -->
  <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
  <!-- Babel (para compilar JSX no navegador) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } = Recharts;
    const todayISO = () => new Date().toISOString().slice(0,10);
    const fmtDate = (d) => new Date(d).toLocaleDateString();
    const uid = () => Math.random().toString(36).slice(2,9);

    function toCSV(rows){
      const headers = ["id","title","category","due","minutes","type","done","remindAt"];
      const lines = [headers.join(",")];
      rows.forEach(r=>{ lines.push(headers.map(h => (""+(r[h]??"")).replaceAll(",",";")).join(",")); });
      return lines.join("\\n");
    }
    function fromCSV(text){
      const [header, ...rest] = text.trim().split(/\\r?\\n/);
      const keys = header.split(",");
      return rest.map(line => {
        const vals = line.split(",");
        const o = {}; keys.forEach((k,i)=>o[k]=vals[i]);
        o.minutes = Number(o.minutes||0); o.done = String(o.done).toLowerCase()==="true";
        return o;
      });
    }
    function canNotify(){ return "Notification" in window; }
    async function askPermission(){ if(!canNotify()) return "denied"; if(Notification.permission!=="granted"){ return await Notification.requestPermission(); } return "granted"; }
    function notify({title, body}){ if(canNotify() && Notification.permission==="granted"){ new Notification(title, { body }); } }
    function buildICS(times){
      const now = new Date(); const dtstamp = now.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
      const makeEvent = (label, hhmm)=>{ const [h,m] = hhmm.split(":"); const start = new Date(); start.setHours(+h,+m,0,0);
        const DTSTART = start.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
        return ["BEGIN:VEVENT","UID:"+ (crypto.randomUUID?.()||uid()) +"@taskplus","DTSTAMP:"+dtstamp,"DTSTART:"+DTSTART,"RRULE:FREQ=DAILY","SUMMARY:Task+ — Lembrete: "+label,"END:VEVENT"].join("\\n"); };
      const body = ["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Task+//PT-BR",""+makeEvent("Revisar prioridades", times.morning),""+makeEvent("Check-in", times.midday),""+makeEvent("Revisão do dia", times.night),"END:VCALENDAR"].join("\\n");
      return new Blob([body], { type:"text/calendar;charset=utf-8" });
    }

    function App(){
      const [tasks, setTasks] = React.useState([]);
      const [draft, setDraft] = React.useState({ id: uid(), title:"", category:"Geral", due: todayISO(), minutes:30, type:"daily", done:false, remindAt:"" });
      const [filter, setFilter] = React.useState({ start: todayISO(), end: todayISO() });
      const [showDone, setShowDone] = React.useState(true);
      const [timer, setTimer] = React.useState({ running:false, seconds:25*60 });
      const [reminders, setReminders] = React.useState({ enabled:false, times:{ morning:"08:00", midday:"13:00", night:"20:30" }, lastFired:{} });

      React.useEffect(()=>{ try{ setTasks(JSON.parse(localStorage.getItem("taskplus.tasks")||"[]")); }catch{} },[]);
      React.useEffect(()=> localStorage.setItem("taskplus.tasks", JSON.stringify(tasks)), [tasks]);
      React.useEffect(()=> localStorage.setItem("taskplus.reminders", JSON.stringify(reminders)), [reminders]);

      const filtered = React.useMemo(()=>{
        const s = new Date(filter.start); const e = new Date(filter.end); e.setHours(23,59,59,999);
        return tasks.filter(t=>{ const d=new Date(t.due); return d>=s && d<=e && (showDone || !t.done); }).sort((a,b)=> new Date(a.due)-new Date(b.due));
      },[tasks,filter,showDone]);

      const byDate = React.useMemo(()=>{
        const map = new Map(); filtered.forEach(t=>{ const k=t.due; if(!map.has(k)) map.set(k,{date:k,total:0,done:0}); const row=map.get(k); row.total++; row.done += t.done?1:0; });
        return [...map.values()].map(r=>({...r,pct:r.total?Math.round(100*r.done/r.total):0})).sort((a,b)=>a.date.localeCompare(b.date));
      },[filtered]);

      const todayStats = React.useMemo(()=> byDate.find(r=>r.date===todayISO()) || {total:0,done:0,pct:0}, [byDate]);

      React.useEffect(()=>{ if(!timer.running) return; const id=setInterval(()=>{ setTimer(t=> t.seconds>0?({...t,seconds:t.seconds-1}):({...t,running:false})); },1000); return ()=>clearInterval(id); },[timer.running]);
      const minutes = String(Math.floor(timer.seconds/60)).padStart(2,"0"); const seconds = String(timer.seconds%60).padStart(2,"0");

      function addTask(){ if(!draft.title.trim()) return; setTasks(p=>[...p,draft]); setDraft({ id: uid(), title:"", category:"Geral", due: draft.due, minutes:30, type:"daily", done:false, remindAt:"" }); }
      function toggleDone(id){ setTasks(p=>p.map(t=>t.id===id?{...t,done:!t.done}:t)); }
      function removeTask(id){ setTasks(p=>p.filter(t=>t.id!==id)); }
      function clearDay(date){ setTasks(p=>p.filter(t=>t.due!==date)); }

      function exportCSV(){ const blob = new Blob([toCSV(tasks)], { type:"text/csv;charset=utf-8;" }); const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`taskplus_${todayISO()}.csv`; a.click(); URL.revokeObjectURL(url); }
      function importCSV(file){ const reader = new FileReader(); reader.onload=()=>{ try{ setTasks(fromCSV(String(reader.result))); }catch{ alert("CSV inválido"); } }; reader.readAsText(file); }
      function setRange(type){
        if(type==="today"){ const iso=todayISO(); setFilter({start:iso,end:iso}); return;}
        if(type==="week"){ const d=new Date(); const day=d.getDay(); const diffStart=(day+6)%7; const start=new Date(d); start.setDate(d.getDate()-diffStart); const end=new Date(start); end.setDate(start.getDate()+6); setFilter({start:start.toISOString().slice(0,10), end:end.toISOString().slice(0,10)}); return;}
        if(type==="month"){ const d=new Date(); const start=new Date(d.getFullYear(),d.getMonth(),1); const end=new Date(d.getFullYear(),d.getMonth()+1,0); setFilter({start:start.toISOString().slice(0,10), end:end.toISOString().slice(0,10)}); return;}
      }
      async function enableBrowserNotifications(){ const perm=await askPermission(); if(perm!=="granted"){ alert("Ative as notificações do navegador para receber lembretes."); return; } setReminders(r=>({...r,enabled:true})); notify({title:"Task+", body:"Notificações do Task+ ativadas."}); }

      React.useEffect(()=>{ if(!reminders.enabled) return; const id=setInterval(()=>{ const now=new Date(); const hh=String(now.getHours()).padStart(2,"0"); const mm=String(now.getMinutes()).padStart(2,"0"); const keyNow=`${hh}:${mm}`; const dateKey=now.toISOString().slice(0,10); const labels={morning:"Revisar prioridades do dia",midday:"Check-in de meio-dia",night:"Revisão do dia"}; Object.entries(reminders.times).forEach(([k,time])=>{ const last=reminders.lastFired?.[k]; if(time===keyNow && last!==dateKey){ notify({title:"Task+", body:labels[k]}); setReminders(r=>({...r,lastFired:{...(r.lastFired||{}),[k]:dateKey}})); } }); },30000); return ()=>clearInterval(id); },[reminders.enabled,reminders.times,reminders.lastFired]);

      // Conectar controles DOM “fora” do React
      React.useEffect(()=>{
        const start=document.getElementById("startDate"), end=document.getElementById("endDate"); start.value=filter.start; end.value=filter.end;
        start.onchange=e=>setFilter(f=>({...f,start:e.target.value})); end.onchange=e=>setFilter(f=>({...f,end:e.target.value}));
        document.getElementById("showDone").onchange=e=>setShowDone(e.target.checked);
        document.getElementById("btnToday").onclick=()=>setRange("today"); document.getElementById("btnWeek").onclick=()=>setRange("week"); document.getElementById("btnMonth").onclick=()=>setRange("month");
        document.getElementById("exportCsvBtn").onclick=exportCSV;
        document.getElementById("importCsvInput").onchange=(e)=>{ const f=e.target.files?.[0]; if(f) importCSV(f); e.target.value=""; };
        document.getElementById("remMorning").value=reminders.times.morning; document.getElementById("remMidday").value=reminders.times.midday; document.getElementById("remNight").value=reminders.times.night;
        document.getElementById("enableNotif").onclick=enableBrowserNotifications; document.getElementById("exportIcs").onclick=()=>{ const blob=buildICS(reminders.times); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="taskplus_lembretes.ics"; a.click(); URL.revokeObjectURL(url); };
        document.getElementById("notifWarn").style.display=("Notification" in window)?"none":"block";
        document.getElementById("due").value=todayISO();
        document.getElementById("addBtn").onclick=()=>{ const title=document.getElementById("title").value.trim(); if(!title){ alert("Digite um título."); return; } const t={ id:uid(), title, category:document.getElementById("category").value||"Geral", due:document.getElementById("due").value||todayISO(), type:document.getElementById("type").value||"daily", minutes:Number(document.getElementById("minutes").value||30), remindAt:document.getElementById("remindAt").value||"", done:false }; setTasks(p=>[...p,t]); document.getElementById("title").value=""; document.getElementById("remindAt").value=""; };
        document.getElementById("quickToday").onclick=()=>setRange("today"); document.getElementById("clearToday").onclick=()=>clearDay(todayISO());
        document.getElementById("timerStart").onclick=()=>setTimer({running:true,seconds:25*60}); document.getElementById("timerPause").onclick=()=>setTimer(t=>({...t,running:false})); document.getElementById("timerReset").onclick=()=>setTimer({running:false,seconds:25*60});
      },[filter,reminders]);

      React.useEffect(()=>{ document.getElementById("timerClock").textContent = minutes+":"+seconds; },[minutes,seconds]);

      React.useEffect(()=>{ 
        document.getElementById("kpiToday").textContent=(todayStats.pct||0)+"%";
        document.getElementById("kpiTodayDone").textContent=todayStats.done||0;
        document.getElementById("kpiTodayTotal").textContent=todayStats.total||0;
        document.getElementById("count").textContent=filtered.length;
        const days=byDate.length; const avg=Math.round((byDate.reduce((a,b)=>a+b.pct,0)/(days||1))); document.getElementById("kpiPeriod").textContent=(avg||0)+"%"; document.getElementById("kpiDays").textContent=days;
        const empty=document.getElementById("empty"); const list=document.getElementById("list"); list.innerHTML="";
        if(!filtered.length){ empty.style.display="block"; } else { empty.style.display="none";
          filtered.forEach(t=>{ const div=document.createElement("div"); div.className="item";
            const left=document.createElement("div"); left.className="row";
            const toggle=document.createElement("button"); toggle.className="btn"; toggle.textContent=t.done?"✅":"⭕"; toggle.onclick=()=>setTasks(p=>p.map(x=>x.id===t.id?{...x,done:!x.done}:x));
            const content=document.createElement("div"); const title=document.createElement("div"); title.textContent=t.title; if(t.done) title.className="strike";
            const meta=document.createElement("div"); meta.className="muted"; meta.innerHTML=[t.category,"•",fmtDate(t.due),"•",t.type,"•",(t.minutes||0)+" min",(t.remindAt?(" • 🔔 "+new Date(t.remindAt).toLocaleString()):"")].join(" ");
            content.appendChild(title); content.appendChild(meta); left.appendChild(toggle); left.appendChild(content);
            const right=document.createElement("div"); const del=document.createElement("button"); del.className="btn"; del.textContent="🗑️ Excluir"; del.onclick=()=>setTasks(p=>p.filter(x=>x.id!==t.id)); right.appendChild(del);
            div.appendChild(left); div.appendChild(right); list.appendChild(div); });
        }
      },[filtered,byDate,todayStats]);

      return React.createElement('div', null);
    }

    const root = ReactDOM.createRoot(document.getElementById("chart"));
    root.render(React.createElement(App));
  </script>
</body>
</html>
